name: CI

on:
  push:
    branches: [ master ]
    tags:
      - "v?[0-9]+.[0-9]+.[0-9]+*"
    paths:
      - '.github/**'
      - '**.rs'
      - 'Cargo.*'
      - 'Dockerfile'
      - 'docker-compose.yml'
  pull_request:
    branches: [ master ]

jobs:
  test:
    name: Test
    runs-on: ubuntu-24.04
    env:
      CARGO_TERM_COLOR: always
    steps:
    - uses: actions/checkout@v4
    - name: Start services
      run: docker compose up -d
    - name: Download example data
      run: docker compose run --rm get-data
    - name: Cache rust build
      uses: Swatinem/rust-cache@v2
    - name: Install cargo-llvm-cov
      uses: taiki-e/install-action@cargo-llvm-cov
    - name: Compile test binary
      run: |
        source <(cargo llvm-cov show-env --export-prefix)
        cargo test --no-run --locked
    - name: Run tests
      run: cargo llvm-cov test --locked --codecov --output-path codecov.json
    - name: Print service logs
      if: failure()
      run: docker compose logs
    - name: Upload coverage to Codecov
      if: always()
      uses: codecov/codecov-action@v4
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: codecov.json
        fail_ci_if_error: true
